-- title:  The Boring World of Niels Bohr
-- author: Torakko, Hattes, sfabian
-- desc:   Help Niels to survive in the boring world
-- script: lua


------ CONSTANTS ----------
-- size
HEIGHT = 136
WIDTH = 240
TILE_SIZE = 8
TILE_HEIGHT = 77 -- 136 / 8
TILE_WIDTH = 30 -- 240 / 8

-- buttons
BUTTON_UP = 0
BUTTON_DOWN = 1
BUTTON_LEFT = 2
BUTTON_RIGHT = 3
BUTTON_Z = 4
BUTTON_X = 5
BUTTON_A = 6
BUTTON_S = 7

-- colors (default palette SWEETIE-16)
BLACK = 0
PURPLE = 1
RED = 2
ORANGE = 3
YELLOW = 4
LIGHT_GREEN = 5
GREEN = 6
DARK_GREEN = 7
DARK_BLUE = 8
BLUE = 9
LIGHT_BLUE = 10
CYAN = 11
WHITE = 12
LIGHT_GREY = 13
GREY = 14
DARK_GREY = 15

-- tile flags
SOLID = 0
DEADLY = 1

-- sprites
DANSK = 256
CAT_CLOSED = 272
CAT_OPEN = 304
BOHR = 275

------ GLOBAL VARIABLES ----------
t=0
mode="menu"
playerA = {
    x=0,
    y=0,
    tileX=1,
    tileY=1,
}
playerB = {
    x=0,
    y=0,
    tileX=1,
    tileY=TILE_HEIGHT - 2,
}

------ FUNCTIONS -----------
function TIC()
    if mode == "menu" then
        cls(BLACK)
        spr(BOHR,0,40,14,6,0,0,1,2)
        spr(BOHR,192,40,14,6,1,0,1,2)
        spr(CAT_OPEN,64,88,14,3,0,0,2,2)
        spr(CAT_CLOSED,128,88,14,3,1,0,2,2)
        print_centered("The Boring World", 10, ORANGE, false, 2)
        print_centered("of Niels Bohr", 30, ORANGE, false, 2)
        print_centered("Based on a true story", 50, ORANGE)
        print_centered("Press Z to start", 75, ORANGE)
        if btn(BUTTON_Z) then
            mode="game"
        end
    elseif mode=="game_over" then
        cls(LIGHT_GREY)
        print("GAME OVER :(", 48, 48)
        print("Press Z to start", 48, 72)
        if btn(BUTTON_Z) then
            mode="game"
        end
    elseif mode=="game" then
        handle_input()
        -- Draw
        cls(LIGHT_GREY)
        map()
        spr(DANSK,playerA.x,playerA.y,14,1,0,0,1,1)
        spr(DANSK,playerB.x,playerB.y,14,1,0,0,1,1)
    end
    t=t+1
end

function handle_input()
    if btnp(BUTTON_UP) then
        moveUp(playerA)
        moveDown(playerB)
    elseif btnp(BUTTON_DOWN) then
        moveDown(playerA)
        moveUp(playerB)
    elseif btnp(BUTTON_LEFT) then
        moveLeft(playerA)
        moveLeft(playerB)
    elseif btnp(BUTTON_RIGHT) then
        moveRight(playerA)
        moveRight(playerB)
    end
    playerA.x = playerA.tileX*8
    playerA.y = playerA.tileY*8
    playerB.x = playerB.tileX*8
    playerB.y = playerB.tileY*8
end

function moveUp(player)
    if collision(player.tileX, player.tileY-1) then return end
    player.tileY = player.tileY - 1
end
function moveDown(player)
    if collision(player.tileX, player.tileY+1) then return end
    player.tileY = player.tileY + 1
end
function moveLeft(player)
    if collision(player.tileX-1, player.tileY) then return end
    player.tileX = player.tileX - 1
end
function moveRight(player)
    if collision(player.tileX+1, player.tileY) then return end
    player.tileX = player.tileX + 1
end

function collision(tileX, tileY)
    tile_id = mget(tileX, tileY)
    if fget(tile_id, SOLID) then
        return true
    elseif fget(tile_id, DEADLY) then
        game_over()
    else
        return false
    end
end

function game_over()
    trace("GAME OVER!")
    mode="game_over"
end

function print_centered(string, y, color, fixed, scale, smallfont)
        y = y or 0
        color = color or 15
        fixed = fixed or false
        scale = scale or 1
        smallfont = smallfont or false
        local string_width = print(string, -100, -100, color, fixed, scale, smallfont)
        return print(string, (WIDTH-string_width)//2, y, color, fixed, scale, smallfont)
end

-- <TILES>
-- 001:ccccccccc2222222c2222222c2222222c2222222c2222222c2222222c222222c
-- 002:cccccccc2222222c2222222c2222222c2222222c2222222c2222222cc222222c
-- 003:9999999999a999999aa999999aa99aa99aa9aaa99999aaa99999aa9999999999
-- 016:ccccccccffcffffffcffffffcfffffffffffcffcffffffcffffffcffcccccccc
-- 017:c222222cc2222222c2222222c2222222c2222222c2222222c2222222cccccccc
-- 018:c222222c2222222c2222222c2222222c2222222c2222222c2222222ccccccccc
-- 032:2222222222222222222222222222222222222222222222222222222222222222
-- 033:c222222cc222222cc222222cc222222cc222222cc222222cc222222cc222222c
-- 034:cccccccc222222222222222222222222222222222222222222222222cccccccc
-- </TILES>

-- <SPRITES>
-- 000:002c2200002c2200222c2222cccccccc222c2222222c2222022c22200cc00cc0
-- 019:00ffef000fefefe0ef4444f00e4e4e40044a4a40044433400442244000444400
-- 032:00004444000044440000444400004444000044440000444f000044443333333f
-- 033:4444000044440000444400004444000044440000f444000044440000fcfc3333
-- 035:0ffc9cf0fffe9efffffe9efffffefeff4ffffff40ffffff00ff00ff022200222
-- 048:0000000000000000000000000000000000000000000000000000000400000044
-- 049:0000000000000000000000000000000000000000000000000000300040003000
-- 064:0000444400444444004444440004444f000444f400004444000044ff333333ff
-- 065:4403000044f30f0044ffff004ff2f2f04ffffff0ffff1ff0ffffff00fffc0fc0
-- </SPRITES>

-- <MAP>
-- 000:102222222222222222222202222222222222222222222222222222222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 001:120000000030300000000012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 002:120000000030300000000012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 003:120000000030300000002202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 004:120000000030300000003030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 005:120000000030300000003030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 006:120000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 007:120000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 008:120101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 009:120000000000000000001020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 010:120000000000000000001121000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 011:120000000030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 012:120000000030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 013:120000000030300000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 014:120000000030300000001212000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 015:120000000030300000121212000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 016:112222222222222222222222222222222222222222222222222222222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </MAP>

-- <WAVES>
-- 000:00000000ffffffff00000000ffffffff
-- 001:0123456789abcdeffedcba9876543210
-- 002:0123456789abcdef0123456789abcdef
-- </WAVES>

-- <SFX>
-- 000:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000304000000000
-- </SFX>

-- <FLAGS>
-- 000:00101020000000000000000000000000101010000000000000000000000000001010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </FLAGS>

-- <PALETTE>
-- 000:1a1c2c5d275db13e53ef7d57ffcd75a7f07038b76425717929366f3b5dc941a6f673eff7f4f4f494b0c2566c86333c57
-- </PALETTE>

